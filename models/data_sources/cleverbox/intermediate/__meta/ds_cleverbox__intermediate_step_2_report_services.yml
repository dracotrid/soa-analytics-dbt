version: 2

models:
  - name: ds_cleverbox__intermediate_step_2_report_services
    description: "CleverBox Intermediate Step 2 Report Services"
    config:
      alias: intermediate_step_2_report_services
      meta:
        tf_config:
          filter: id IS NOT NULL
    columns:
      - name: id
        data_type: STRING
        description: Record identifier
      - name: date
        data_type: DATE
        description: Service date of sale
      - name: year
        data_type: NUMERIC
        description: Service year of sale
      - name: month
        data_type: NUMERIC
        description: Service month of sale
      - name: day
        data_type: NUMERIC
        description: Service day of sale
      - name: branch
        data_type: STRING
        description: Branch of service sale
      - name: specialist
        data_type: STRING
        description: ""
      - name: speciality
        data_type: STRING
        description: ""
      - name: client_name
        data_type: STRING
        description: ""
      - name: is_vip
        data_type: BOOLEAN
        description: ""
      - name: is_employee
        data_type: BOOLEAN
        description: ""
      - name: name
        data_type: STRING
        description: Service name
      - name: category
        data_type: STRING
        description: Service category
      - name: direction
        data_type: STRING
        description: Service direction
      - name: amount
        data_type: NUMERIC
        description: Service amount
      - name: price_unit
        data_type: NUMERIC.PRICE
        description: ""
      - name: cost_unit
        data_type: NUMERIC.COST
        description: ""
      - name: cost_price_unit
        data_type: NUMERIC.PRICE
        description: ""
      - name: subscription
        data_type: NUMERIC.COST
        description: ""
      - name: discount_unit
        data_type: NUMERIC.COST
        description: ""
      - name: payback_unit
        data_type: NUMERIC.COST
        description: ""
      - name: bonus_employee_code
        data_type: STRING
        description: ""
      - name: bonus_employee_value
        data_type: NUMERIC.PRICE
        description: ""
      - name: bonus_employee_type
        data_type: STRING
        description: ""
      - name: discount_name_source
        data_type: STRING
        description: ""
      - name: bonus_discount_type
        data_type: STRING
        description: ""
      - name: bonus_discount_value
        data_type: STRING
        description: ""
      - name: bonus_adjustment_type
        data_type: STRING
        description: ""
      - name: discount_rate
        data_type: STRING
        description: ""
      - name: bonus_type_calculation
        data_type: STRING
        description: ""
        meta:
          tf_config:
            expression: CASE WHEN bonus_adjustment_type IS NOT NULL THEN bonus_adjustment_type
                             WHEN bonus_employee_type IS NULL THEN 'БезПремії'
                             WHEN bonus_employee_type = 'Фіксована' THEN bonus_employee_type
                             WHEN is_employee = TRUE THEN '%ВідОплати'
                             WHEN subscription IS NOT NULL AND subscription > 0 THEN bonus_employee_type
                             WHEN is_vip = TRUE OR IFNULL(discount_rate, 0) = 1 THEN '%ВідВартості'
                             WHEN bonus_discount_type IS NULL OR bonus_discount_type = '' THEN bonus_employee_type
                             ELSE bonus_discount_type
                        END
      - name: bonus_value
        data_type: NUMERIC.PRICE
        description: ""
        meta:
          tf_config:
            expression: CASE WHEN bonus_discount_value IS NULL THEN bonus_employee_value ELSE bonus_discount_value END
      - name: is_bonus_without_cost_price
        data_type: BOOLEAN
        description: ""
        meta:
          tf_config:
            expression: CASE WHEN year = 2024 OR speciality IN ('Манікюр', 'Подолог') THEN TRUE ELSE FALSE END
      - name: cost_total
        data_type: NUMERIC.COST
        description: ""
        meta:
          tf_config:
            macro: cmf_multiply
            params: [amount, cost_unit]
      - name: income_unit
        data_type: NUMERIC.COST
        description: ""
        meta:
          tf_config:
            expression: CASE WHEN IFNULL(subscription, 0) > 0 THEN 0
                             WHEN (IFNULL(price_unit, 0) - IFNULL(certificates_sum, 0)) < 1 THEN 0
                             ELSE IFNULL(price_unit, 0) - IFNULL(certificates_sum, 0)
                        END
      - name: discount_total
        data_type: NUMERIC.COST
        description: ""
        meta:
          tf_config:
            macro: cmf_multiply
            params: [amount, discount_unit]
      - name: cost_price_total
        data_type: NUMERIC.PRICE
        description: ""
        meta:
          tf_config:
            macro: cmf_multiply
            params: [amount, cost_price_unit]
      - name: discount_percent_unit
        data_type: NUMERIC.PRICE
        description: ""
        meta:
          tf_config:
            macro: cmf_divide
            params: [discount_unit, price_unit]
